<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torn Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Inter', 'DM Sans', Arial, sans-serif;
            background: #fafbfc;
            color: #232526;
            height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .center-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 400px;
        }
        .center-box h2 {
            font-size: 1.35rem;
            font-weight: 500;
            margin-bottom: 28px;
            letter-spacing: -0.2px;
            font-family: 'DM Sans', 'Inter', Arial, sans-serif;
        }
        .api-input {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        .api-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1.2px solid #e3e6ea;
            border-radius: 8px;
            font-family: 'Inter', 'DM Sans', Arial, sans-serif;
            font-size: 15px;
            background: #f6f8fa;
            color: #232526;
            transition: all 0.2s cubic-bezier(.4,0,.2,1);
        }
        .api-input input:focus {
            outline: none;
            border-color: #232526;
            background: #fff;
            box-shadow: 0 0 0 2px rgba(35,37,38,0.08);
        }
        .api-input button {
            padding: 12px 28px;
            background: linear-gradient(90deg, #232526 0%, #414345 100%);
            color: #fff;
            border: none;
            border-radius: 22px;
            font-family: 'DM Sans', 'Inter', Arial, sans-serif;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(.4,0,.2,1);
            box-shadow: 0 2px 8px rgba(35,37,38,0.07);
            letter-spacing: 0.01em;
            position: relative;
        }
        .api-input button:hover, .api-input button:focus {
            background: linear-gradient(90deg, #414345 0%, #232526 100%);
            box-shadow: 0 6px 18px rgba(35,37,38,0.13);
            transform: translateY(-1px) scale(1.04);
        }
        .error-message {
            color: #e63946;
            font-size: 0.98rem;
            margin-top: 18px;
            min-height: 22px;
            font-family: 'Inter', 'DM Sans', Arial, sans-serif;
            letter-spacing: -0.2px;
        }
        .success-message {
            color: #16a34a;
            font-size: 1.05rem;
            margin-top: 22px;
            font-family: 'Inter', 'DM Sans', Arial, sans-serif;
            letter-spacing: -0.2px;
        }
        /* Management System Styles */
        .dashboard {
            width: 100vw;
            height: 100vh;
            background: #fafbfc;
            display: flex;
            flex-direction: column;
        }
        .dashboard-header {
            display: flex;
            gap: 0;
            background: #fff;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            border-bottom: 1px solid #ececec;
            padding: 0 0 0 0;
        }
        .dashboard-tab {
            padding: 18px 36px;
            font-size: 1rem;
            font-family: 'DM Sans', 'Inter', Arial, sans-serif;
            font-weight: 500;
            color: #232526;
            background: none;
            border: none;
            border-bottom: 2.5px solid transparent;
            cursor: pointer;
            transition: all 0.18s cubic-bezier(.4,0,.2,1);
        }
        .dashboard-tab.active {
            border-bottom: 2.5px solid #232526;
            color: #232526;
            background: #f6f8fa;
        }
        .dashboard-tab:not(.active):hover {
            background: #f6f8fa;
        }
        .dashboard-content {
            flex: 1;
            padding: 40px 32px 0 32px;
            width: 100%;
            box-sizing: border-box;
        }
        .in-progress {
            text-align: center;
            color: #888;
            font-size: 1.2rem;
            margin-top: 80px;
            font-family: 'Inter', 'DM Sans', Arial, sans-serif;
        }
        .logs-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            overflow: hidden;
        }
        .logs-table th, .logs-table td {
            padding: 10px 14px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.97rem;
            text-align: left;
        }
        .logs-table th {
            background: #f6f8fa;
            font-weight: 600;
        }
        .logs-table tr:last-child td {
            border-bottom: none;
        }
        .item-name {
            color: #232526;
            font-weight: 500;
        }
        /* Items grid */
        .inventory-loading {
            text-align: center;
            color: #888;
            font-size: 1.1rem;
            margin-top: 40px;
        }
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 18px;
            margin-top: 24px;
            justify-items: center;
        }
        .inventory-item {
            background: #f3f4f6;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(24,26,27,0.10), 0 1px 2px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            width: 96px;
            height: 96px;
            min-width: 96px;
            min-height: 96px;
            aspect-ratio: 1/1;
            position: relative;
            overflow: hidden;
            border: 1px solid #232526;
            transition: box-shadow 0.18s cubic-bezier(.4,0,.2,1), transform 0.18s cubic-bezier(.4,0,.2,1);
        }
        .inventory-item:hover {
            box-shadow: 0 6px 18px rgba(24,26,27,0.18), 0 1.5px 4px rgba(0,0,0,0.10);
            transform: translateY(-2px) scale(1.04);
        }
        .inventory-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 12px;
            background: #232526;
            display: block;
            transition: filter 0.18s cubic-bezier(.4,0,.2,1);
        }
        .inventory-item:hover img {
            filter: brightness(0.7) blur(0.5px);
        }
        .inventory-item .card-gradient {
            position: absolute;
            left: 0; right: 0; bottom: 0;
            height: 50%;
            background: linear-gradient(0deg, rgba(24,26,27,0.92) 80%, rgba(24,26,27,0.0) 100%);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.22s cubic-bezier(.4,0,.2,1);
        }
        .inventory-item:hover .card-gradient {
            opacity: 1;
        }
        .inventory-item .item-name,
        .inventory-item .item-qty {
            position: absolute;
            left: 0;
            width: 100%;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.22s cubic-bezier(.4,0,.2,1);
            text-align: center;
            color: #fff;
            z-index: 2;
        }
        .inventory-item .item-name {
            bottom: 28px;
            font-size: 0.98rem;
            font-weight: 600;
            padding: 0 0 1px 0;
            text-shadow: 0 1px 4px rgba(0,0,0,0.14);
        }
        .inventory-item .item-qty {
            bottom: 12px;
            font-size: 0.92rem;
            font-weight: 500;
            text-shadow: 0 1px 4px rgba(0,0,0,0.14);
        }
        .inventory-item:hover .item-name,
        .inventory-item:hover .item-qty {
            opacity: 1;
            pointer-events: auto;
        }
        .travel-bar {
            width: 340px;
            max-width: 96vw;
            background: #2563eb;
            color: #f3f6fa;
            font-size: 0.78rem;
            font-family: 'DM Sans', 'Inter', Arial, sans-serif;
            font-weight: 500;
            padding: 10px 14px 14px 14px;
            border-radius: 12px;
            margin-bottom: 18px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.14);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 64px;
        }
        .travel-bar-content {
            width: 100%;
            max-width: 320px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .travel-bar-top {
            font-size: 0.85rem;
            font-weight: 700;
            color: #f3f6fa;
            text-shadow: 0 2px 8px #0008;
        }
        .travel-bar-info {
            font-size: 0.75rem;
            margin-bottom: 6px;
            color: #e6eaf0;
            letter-spacing: 0.01em;
        }
        .travel-bar-icons {
            display: flex;
            align-items: center;
            width: 100%;
            justify-content: space-between;
            margin-bottom: 0;
        }
        .travel-bar-icon {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: #232b33;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            box-shadow: 0 2px 8px #0005;
            border: 2px solid #222a33;
        }
        .travel-bar-progress-wrap {
            flex: 1;
            margin: 0 8px;
            position: relative;
            display: flex;
            align-items: center;
        }
        .travel-bar-progress-bg {
            width: 100%;
            height: 7px;
            background: #232b33;
            border-radius: 5px;
            box-shadow: 0 1px 4px #0004;
            overflow: hidden;
            position: relative;
        }
        .travel-bar-progress {
            height: 100%;
            background: linear-gradient(90deg, #5ec6fa 0%, #3b82f6 100%);
            border-radius: 5px;
            transition: width 0.5s cubic-bezier(.4,0,.2,1);
            position: absolute;
            left: 0; top: 0;
        }
        .travel-bar-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.95rem;
            color: #fff;
            filter: drop-shadow(0 2px 4px #0008);
            left: 0;
            transition: left 0.5s cubic-bezier(.4,0,.2,1);
            z-index: 2;
        }
        @keyframes plane-move {
            from { left: 0%; }
            to { left: 100%; }
        }
        /* Travel Log Modal/Page */
        .travel-log-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(20,24,30,0.92);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }
        .travel-log-content {
            background: #181e24;
            border-radius: 18px;
            box-shadow: 0 4px 32px #0008;
            padding: 32px 28px 24px 28px;
            min-width: 320px;
            max-width: 98vw;
            min-height: 220px;
            color: #f3f6fa;
            font-family: 'DM Sans', 'Inter', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .travel-log-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 18px;
        }
        .travel-log-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 18px;
        }
        .travel-log-table th, .travel-log-table td {
            padding: 7px 10px;
            border-bottom: 1px solid #232b33;
            text-align: left;
            font-size: 0.98rem;
        }
        .travel-log-table th {
            color: #8ec6fa;
            font-weight: 600;
            background: #1a2128;
        }
        .travel-log-table tr:last-child td {
            border-bottom: none;
        }
        .travel-log-close {
            background: #232b33;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 7px 18px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: background 0.15s;
        }
        .travel-log-close:hover {
            background: #3b82f6;
        }
        /* Income/Expenses Summary Box */
        .activity-header-row {
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
            align-items: flex-start;
            gap: 24px;
            margin: 24px 0 18px 48px;
            flex-wrap: wrap;
        }
        @media (max-width: 900px) {
            .activity-header-row {
                margin-left: 12px;
            }
        }
        @media (max-width: 700px) {
            .activity-header-row {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
                margin-left: 0;
            }
            .income-expense-box, .travel-bar {
                max-width: 100%;
            }
        }
        .income-expense-box {
            background: #dc2626;
            border-radius: 18px;
            box-shadow: 0 4px 24px #0006;
            padding: 22px 36px 18px 36px;
            min-width: 220px;
            max-width: 340px;
            color: #f3f6fa;
            font-family: 'DM Sans', 'Inter', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            position: relative;
        }
        .expense-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 18px;
        }
        .expense-toggle-btn {
            background: #232b33;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 5px 14px;
            font-size: 0.98rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s;
            opacity: 0.7;
        }
        .expense-toggle-btn.active, .expense-toggle-btn:hover {
            background: #fff;
            color: #dc2626;
            opacity: 1;
        }
        .travel-bar {
            margin: 0;
        }
        .income-expense-title {
            font-size: 1.18rem;
            font-weight: 700;
            margin-bottom: 12px;
        }
        .income-expense-row {
            font-size: 1.05rem;
            font-weight: 500;
            margin-bottom: 6px;
            width: 100%;
            display: flex;
            justify-content: space-between;
        }
        .income-expense-row:last-child {
            margin-bottom: 0;
        }

        /* Faction Information Styles */
        .faction-header {
            display: flex;
            gap: 20px;
            align-items: center;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            margin-bottom: 20px;
        }

        .faction-logo {
            flex-shrink: 0;
        }

        .faction-details {
            flex: 1;
        }

        .faction-line-1 {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 12px;
        }

        .war-mode-btn {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
        }

        .war-mode-btn:hover {
            background: linear-gradient(135deg, #b91c1c, #dc2626);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
        }

        .war-mode-btn.active {
            background: linear-gradient(135deg, #059669, #047857);
            box-shadow: 0 2px 4px rgba(5, 150, 105, 0.2);
        }

        .war-mode-btn.active:hover {
            background: linear-gradient(135deg, #047857, #059669);
            box-shadow: 0 4px 8px rgba(5, 150, 105, 0.3);
        }

        .faction-line-2 {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 0.85rem;
            color: #6b7280;
        }

        .faction-stat {
            white-space: nowrap;
        }

        .faction-members-section {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            margin-top: 20px;
        }

        /* Stocks Table Styles */
        .stocks-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
        }

        .stocks-table th {
            background: #f8fafc;
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9rem;
        }

        .stocks-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: top;
        }

        .stocks-table tr:hover {
            background: #f9fafb;
        }

        .stock-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stock-name {
            font-weight: 600;
            color: #232526;
            font-size: 0.95rem;
        }

        .stock-acronym {
            font-size: 0.8rem;
            color: #6b7280;
            font-weight: 500;
        }

        .stock-price {
            font-weight: 600;
            color: #059669;
            font-size: 0.95rem;
        }

        .stock-market-cap {
            font-size: 0.9rem;
            color: #374151;
        }

        .stock-shares {
            font-size: 0.9rem;
            color: #374151;
        }

        .stock-investors {
            font-size: 0.9rem;
            color: #374151;
        }

        .stock-benefit {
            max-width: 300px;
        }

        .benefit-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .benefit-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            width: fit-content;
        }

        .benefit-type.active {
            background: #dcfce7;
            color: #166534;
        }

        .benefit-type.passive {
            background: #dbeafe;
            color: #1e40af;
        }

        .benefit-desc {
            font-size: 0.85rem;
            color: #232526;
            font-weight: 500;
        }

        .benefit-req {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .stock-frequency {
            max-width: 120px;
        }

        .frequency-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .frequency-days {
            font-weight: 600;
            color: #059669;
            font-size: 0.9rem;
        }

        .frequency-desc {
            font-size: 0.8rem;
            color: #6b7280;
            font-weight: 500;
        }

        .stock-price-change {
            font-weight: 600;
            font-size: 0.9rem;
            text-align: center;
        }

        .stock-price-change.positive {
            color: #059669;
        }

        .stock-price-change.negative {
            color: #dc2626;
        }

        .stock-price-min {
            font-size: 0.9rem;
            color: #374151;
            font-weight: 500;
        }

        .stock-portfolio-shares {
            font-size: 0.9rem;
            color: #374151;
            font-weight: 500;
            text-align: center;
        }

        .stock-portfolio-avg {
            font-size: 0.9rem;
            color: #374151;
            font-weight: 500;
        }

        .stock-portfolio-value {
            font-size: 0.9rem;
            color: #374151;
            font-weight: 600;
        }

        .stock-portfolio-pnl {
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
        }

        .stock-portfolio-pnl.positive {
            color: #059669;
        }

        .stock-portfolio-pnl.negative {
            color: #dc2626;
        }

        .pnl-percent {
            font-size: 0.8rem;
            margin-top: 2px;
        }


        .members-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
        }

        .members-table th, .members-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
            text-align: left;
        }

        .members-table th {
            background: #f6f8fa;
            font-weight: 600;
            color: #374151;
        }

        .sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }

        .sortable:hover {
            background: #e5e7eb !important;
        }

        .sortable.asc::after {
            content: " ↑";
            color: #059669;
        }

        .sortable.desc::after {
            content: " ↓";
            color: #dc2626;
        }

        .members-table tr:last-child td {
            border-bottom: none;
        }

        .members-table tr:hover {
            background: #f9fafb;
        }

        .member-name {
            font-weight: 500;
            color: #232526;
        }

        .member-position {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .member-status {
            font-size: 0.85rem;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        .status-online {
            background: #dcfce7;
            color: #166534;
        }

        .status-idle {
            background: #fef3c7;
            color: #92400e;
        }

        .status-offline {
            background: #f3f4f6;
            color: #6b7280;
        }

        .status-hospital {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-jail {
            background: #fef3c7;
            color: #92400e;
        }

        .status-traveling {
            background: #dbeafe;
            color: #1e40af;
        }

        .war-history-section {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            margin-bottom: 20px;
        }

        .war-history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .war-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s;
        }

        .war-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .war-card.current {
            border-color: #dc2626;
            background: #fef2f2;
        }

        .war-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .war-id {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 500;
        }

        .war-status {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        .war-status.ongoing {
            background: #dcfce7;
            color: #166534;
        }

        .war-status.completed {
            background: #f3f4f6;
            color: #6b7280;
        }

        .war-factions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .war-faction {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-radius: 6px;
            background: white;
        }

        .war-faction.winner {
            background: #dcfce7;
            border: 1px solid #bbf7d0;
        }

        .war-faction.our-faction {
            background: #dbeafe;
            border: 1px solid #93c5fd;
        }

        .faction-name {
            font-weight: 500;
            color: #232526;
        }

        .faction-score {
            font-weight: 600;
            color: #059669;
        }

        .faction-chain {
            font-size: 0.8rem;
            color: #6b7280;
            margin-left: 8px;
        }

        .war-target {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 8px;
            text-align: center;
        }

        .faction-balance-summary {
            background: #fff;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }

        .balance-header h3 {
            margin: 0 0 12px 0;
            font-size: 1rem;
            font-weight: 600;
            color: #232526;
        }

        .balance-totals {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }

        .balance-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .balance-label {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 500;
        }

        .balance-value {
            font-size: 1rem;
            font-weight: 600;
            color: #059669;
        }

        .balance-value.money {
            color: #059669;
        }

        .balance-value.points {
            color: #7c3aed;
        }

        .balance-value.scope {
            color: #dc2626;
        }

        /* War Report Modal */
        .war-report-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .war-report-content {
            background: #fff;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            padding: 24px;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .war-report-close {
            position: absolute;
            top: 16px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .war-report-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .war-report-header {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
        }

        .war-report-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #232526;
            margin-bottom: 8px;
        }

        .war-report-meta {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .war-report-factions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .war-faction-detail {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
        }

        .war-faction-detail.winner {
            border-color: #059669;
            background: #f0fdf4;
        }

        .faction-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .faction-detail-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #232526;
        }

        .faction-detail-score {
            font-size: 1.1rem;
            font-weight: 700;
            color: #059669;
        }

        .faction-detail-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .faction-stat-item {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .faction-stat-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .faction-stat-value {
            font-size: 1rem;
            font-weight: 600;
            color: #232526;
        }

        .faction-rewards {
            margin-bottom: 16px;
        }

        .rewards-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .rewards-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .reward-item {
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .rewards-total {
            margin-top: 12px;
            padding: 8px 12px;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reward-total-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #166534;
        }

        .reward-total-value {
            font-size: 1rem;
            font-weight: 700;
            color: #059669;
        }

        .payout-calculator-btn {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 12px;
        }

        .payout-calculator-btn:hover {
            background: linear-gradient(135deg, #6d28d9, #7c3aed);
            transform: translateY(-1px);
        }

        /* Payout Calculator Modal */
        .payout-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .payout-content {
            background: #fff;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            padding: 24px;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .payout-close {
            position: absolute;
            top: 16px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .payout-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .payout-header {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
        }

        .payout-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #232526;
            margin-bottom: 8px;
        }

        .payout-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .payout-summary-item {
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .payout-summary-label {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .payout-summary-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #232526;
        }

        .payout-settings {
            margin-bottom: 24px;
        }

        .payout-settings-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #232526;
            margin-bottom: 16px;
        }

        .payout-presets {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .preset-btn {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-btn:hover {
            background: #e5e7eb;
        }

        .preset-btn.active {
            background: #7c3aed;
            color: white;
            border-color: #7c3aed;
        }

        .payout-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .payout-input-group {
            display: flex;
            flex-direction: column;
        }

        .payout-input-label {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .payout-input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .input-help {
            display: block;
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 4px;
            font-style: italic;
        }

        .payout-results {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
        }

        .payout-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .payout-results-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #232526;
        }

        .export-btn {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-btn:hover {
            background: linear-gradient(135deg, #047857, #059669);
            transform: translateY(-1px);
        }

        .payout-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .payout-table th,
        .payout-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .payout-table th {
            background: #f6f8fa;
            font-weight: 600;
            color: #374151;
        }

        .payout-table tr:hover {
            background: #f9fafb;
        }

        .member-payout {
            font-weight: 600;
            color: #059669;
        }

        .special-member {
            background: #fef3c7;
        }

        .faction-members-section {
            margin-top: 16px;
        }

        .members-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
        }

        .members-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .members-table th,
        .members-table td {
            padding: 6px 8px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .members-table th {
            background: #f6f8fa;
            font-weight: 600;
            color: #374151;
        }

        .members-table tr:hover {
            background: #f9fafb;
        }

        .member-score {
            font-weight: 600;
            color: #059669;
        }

        .member-attacks {
            color: #dc2626;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="center-box" id="mainBox">
        <h2>Enter API Key</h2>
        <div class="api-input">
            <input type="text" id="apiKey" placeholder="Your Torn API key" minlength="16" maxlength="64">
            <button id="connectBtn" onclick="connectAPI()">Connect</button>
        </div>
        <div class="error-message" id="errorMsg"></div>
        <div class="success-message" id="successMsg"></div>
    </div>
    <div id="dashboard" class="dashboard" style="display:none;">
        <div class="dashboard-header">
            <button class="dashboard-tab active" data-tab="activities">Activities</button>
            <button class="dashboard-tab" data-tab="stocks">Stocks</button>
            <button class="dashboard-tab" data-tab="rawlogs">Raw Logs</button>
            <button class="dashboard-tab" data-tab="company">Company</button>
            <button class="dashboard-tab" data-tab="faction">Faction</button>
        </div>
        <div class="dashboard-content">
            <div class="tab-content" id="tab-activities">
                <div class="activity-header-row">
                    <div id="travel-bar" class="travel-bar" style="cursor:pointer;">Loading travel status...</div>
                    <div id="income-expense-box" class="income-expense-box">
                        <div class="income-expense-title">Summary</div>
                        <div class="income-expense-row"><span>Income:</span> <span id="income-amount">$0</span></div>
                        <div class="income-expense-row"><span>Expenses:</span> <span id="expense-amount">$0</span></div>
                        <div class="expense-toggle">
                            <button class="expense-toggle-btn active" id="expense-toggle-daily" onclick="setExpensePeriod('daily')">Daily</button>
                            <button class="expense-toggle-btn" id="expense-toggle-weekly" onclick="setExpensePeriod('weekly')">Weekly</button>
                            <button class="expense-toggle-btn" id="expense-toggle-monthly" onclick="setExpensePeriod('monthly')">Monthly</button>
                        </div>
                    </div>
                </div>
                <div class="in-progress">Page in progress</div>
            </div>
            <div class="tab-content" id="tab-stocks" style="display:none;">
                <h2 style="font-size:1.2rem;font-weight:600;margin-bottom:18px;">Stock Market</h2>
                <div id="stocks-loading" class="inventory-loading">Loading stock market data...</div>
                <div id="stocks-content" style="display:none;">
                    <div id="stocks-container"></div>
                </div>
            </div>
            <div class="tab-content" id="tab-rawlogs" style="display:none;">
                <h2 style="font-size:1.2rem;font-weight:600;margin-bottom:18px;">Raw Logs</h2>
                <div id="logs-loading">Loading logs...</div>
                <table class="logs-table" id="logs-table" style="display:none;">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="logs-tbody"></tbody>
                </table>
            </div>
            <div class="tab-content" id="tab-company" style="display:none;">
                <div class="in-progress">Page in progress</div>
            </div>
            <div class="tab-content" id="tab-faction" style="display:none;">
                <h2 style="font-size:1.2rem;font-weight:600;margin-bottom:18px;">Faction Information</h2>
                <div id="faction-loading" class="inventory-loading">Loading faction data...</div>
                <div id="faction-basic-info" style="display:none;">
                    <div class="faction-header">
                        <div class="faction-logo">
                            <img id="faction-tag-image" src="" alt="Faction Tag" style="width:60px;height:60px;border-radius:8px;object-fit:cover;">
                        </div>
                        <div class="faction-details">
                            <div class="faction-line-1">
                                <span id="faction-tag" style="font-size:1rem;color:#6b7280;margin-right:8px;"></span>
                                <span id="faction-name" style="font-size:1.4rem;font-weight:600;color:#232526;"></span>
                                <button id="war-mode-toggle" class="war-mode-btn" onclick="toggleWarMode()">⚔️ War Mode</button>
                            </div>
                            <div class="faction-line-2">
                                <span class="faction-stat">ID: <span id="faction-id"></span></span>
                                <span class="faction-stat">Respect: <span id="faction-respect"></span></span>
                                <span class="faction-stat">Members: <span id="faction-members"></span>/<span id="faction-capacity"></span></span>
                                <span class="faction-stat">Age: <span id="faction-days-old"></span>d</span>
                                <span class="faction-stat">Leader: <span id="faction-leader"></span></span>
                                <span class="faction-stat">Co-Leader: <span id="faction-co-leader"></span></span>
                                <span class="faction-stat">Rank: <span id="faction-rank-name"></span> L<span id="faction-rank-level"></span></span>
                                <span class="faction-stat">Wins: <span id="faction-rank-wins"></span></span>
                                <span class="faction-stat">Chain: <span id="faction-best-chain"></span></span>
                                <span class="faction-stat">Enlisted: <span id="faction-enlisted"></span></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- War Mode Section -->
                    <div id="war-mode-section" style="display:none;">
                        <div class="war-history-section">
                            <h3 style="font-size:1.1rem;font-weight:600;margin-bottom:16px;color:#232526;">Ranked War History</h3>
                            <div id="war-history-loading" class="inventory-loading">Loading war history...</div>
                            <div id="war-history-list" style="display:none;">
                                <div class="war-history-grid" id="war-history-grid"></div>
                            </div>
                        </div>
                    </div>
                    

                    
                    <div class="faction-members-section">
                        <div class="faction-balance-summary" id="faction-balance-summary" style="display:none;">
                            <div class="balance-header">
                                <h3 style="font-size:1.1rem;font-weight:600;margin-bottom:8px;color:#232526;">Faction Balance</h3>
                                <div class="balance-totals">
                                    <span class="balance-item">
                                        <span class="balance-label">Total Money:</span>
                                        <span class="balance-value" id="faction-total-money">$0</span>
                                    </span>
                                    <span class="balance-item">
                                        <span class="balance-label">Total Points:</span>
                                        <span class="balance-value" id="faction-total-points">0</span>
                                    </span>
                                    <span class="balance-item">
                                        <span class="balance-label">Scope:</span>
                                        <span class="balance-value" id="faction-scope">0</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <h3 style="font-size:1.1rem;font-weight:600;margin-bottom:16px;color:#232526;">Members</h3>
                        <div id="faction-members-loading" class="inventory-loading">Loading members...</div>
                        <div id="faction-members-list" style="display:none;">
                            <table class="members-table">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-sort="name">Name ↕</th>
                                        <th class="sortable" data-sort="level">Level ↕</th>
                                        <th class="sortable" data-sort="position">Position ↕</th>
                                        <th class="sortable" data-sort="status">Status ↕</th>
                                        <th class="sortable" data-sort="money">Money ↕</th>
                                        <th class="sortable" data-sort="points">Points ↕</th>
                                        <th class="sortable" data-sort="lastAction">Last Action ↕</th>
                                        <th class="sortable" data-sort="daysInFaction">Days in Faction ↕</th>
                                    </tr>
                                </thead>
                                <tbody id="members-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Travel Log Modal/Page -->
    <div id="travel-log-modal" class="travel-log-modal" style="display:none;">
        <div class="travel-log-content">
            <div class="travel-log-title">Travel Log</div>
            <div id="travel-log-counts" style="margin-bottom:18px;width:100%;text-align:center;">
                <div style="font-size:1.1rem;margin-bottom:10px;">Travels Completed</div>
                <div style="font-size:1.05rem;margin-bottom:6px;">Daily: <span id="travel-count-daily">0</span></div>
                <div id="travel-dest-daily" style="font-size:0.98rem;margin-bottom:10px;"></div>
                <div style="font-size:1.05rem;margin-bottom:6px;">Weekly: <span id="travel-count-weekly">0</span></div>
                <div id="travel-dest-weekly" style="font-size:0.98rem;margin-bottom:10px;"></div>
                <div style="font-size:1.05rem;">Monthly: <span id="travel-count-monthly">0</span></div>
                <div id="travel-dest-monthly" style="font-size:0.98rem;"></div>
            </div>
            <button class="travel-log-close" onclick="closeTravelLog()">Back</button>
        </div>
    </div>

    <!-- War Report Modal -->
    <div id="war-report-modal" class="war-report-modal">
        <div class="war-report-content">
            <button class="war-report-close" onclick="closeWarReport()">×</button>
            <div id="war-report-loading" class="inventory-loading">Loading war report...</div>
            <div id="war-report-data" style="display:none;">
                <div class="war-report-header">
                    <div class="war-report-title" id="war-report-title">War Report</div>
                    <div class="war-report-meta" id="war-report-meta"></div>
                </div>
                <div class="war-report-factions" id="war-report-factions"></div>
            </div>
        </div>
    </div>

    <!-- Payout Calculator Modal -->
    <div id="payout-modal" class="payout-modal">
        <div class="payout-content">
            <button class="payout-close" onclick="closePayoutCalculator()">×</button>
            <div class="payout-header">
                <div class="payout-title">War Payout Calculator</div>
            </div>
            
            <div class="payout-summary">
                <div class="payout-summary-item">
                    <div class="payout-summary-label">Total Cache Value</div>
                    <div class="payout-summary-value" id="total-cache-value">$0</div>
                </div>
                <div class="payout-summary-item">
                    <div class="payout-summary-label">Faction Share (20%)</div>
                    <div class="payout-summary-value" id="faction-share">$0</div>
                </div>
                <div class="payout-summary-item">
                    <div class="payout-summary-label">Member Share (80%)</div>
                    <div class="payout-summary-value" id="member-share">$0</div>
                </div>
                <div class="payout-summary-item">
                    <div class="payout-summary-label">Total Attacks</div>
                    <div class="payout-summary-value" id="total-attacks">0</div>
                </div>
            </div>
            
            <div class="payout-settings">
                <div class="payout-settings-title">Distribution Settings</div>
                
                <div class="payout-presets">
                    <button class="preset-btn active" onclick="setPreset('standard')">Standard (80/20)</button>
                    <button class="preset-btn" onclick="setPreset('leader-bonus')">Leader Bonus</button>
                    <button class="preset-btn" onclick="setPreset('top-attackers')">Top Attackers</button>
                    <button class="preset-btn" onclick="setPreset('custom')">Custom</button>
                </div>
                
                <div class="payout-inputs">
                    <div class="payout-input-group">
                        <label class="payout-input-label">Actual Cache Sale Value ($)</label>
                        <input type="number" id="actual-cache-value" class="payout-input" placeholder="Enter actual sale value" min="0" step="1000" onchange="calculatePayout()">
                        <small class="input-help">Leave empty to use estimated value: $<span id="estimated-cache-value">0</span></small>
                    </div>
                    <div class="payout-input-group">
                        <label class="payout-input-label">Faction Share (%)</label>
                        <input type="number" id="faction-percentage" class="payout-input" value="20" min="0" max="100" onchange="calculatePayout()">
                    </div>
                    <div class="payout-input-group">
                        <label class="payout-input-label">Special Member Name</label>
                        <input type="text" id="special-member-name" class="payout-input" placeholder="e.g., Leader, Top Attacker" onchange="calculatePayout()">
                    </div>
                    <div class="payout-input-group">
                        <label class="payout-input-label">Special Member Share (%)</label>
                        <input type="number" id="special-member-percentage" class="payout-input" value="0" min="0" max="80" onchange="calculatePayout()">
                    </div>
                </div>
            </div>
            
            <div class="payout-results">
                <div class="payout-results-header">
                    <div class="payout-results-title">Member Payouts</div>
                    <button class="export-btn" onclick="exportPayoutTable()">
                        📊 Export CSV
                    </button>
                </div>
                <table class="payout-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Level</th>
                            <th>Attacks</th>
                            <th>Attack Share (%)</th>
                            <th>Payout</th>
                        </tr>
                    </thead>
                    <tbody id="payout-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        // Minimal item lookup for demo (expand as needed)
        const itemLookup = {
            197: 'Ecstasy',
            527: 'Candy',
            67: 'First Aid Kit',
            97: 'Morphine',
            902: 'Energy Drink',
            903: 'Energy Bar',
            437: 'Flower',
            1301: 'Special Item',
            485: 'Book',
            210: 'Beer',
            366: 'Company Special',
            // ... add more as needed
        };
        let apiKey = '';
        let itemDetails = {};
        async function connectAPI() {
            const keyInput = document.getElementById('apiKey');
            const apiKeyValue = keyInput.value.trim();
            const errorMsg = document.getElementById('errorMsg');
            const successMsg = document.getElementById('successMsg');
            errorMsg.textContent = '';
            successMsg.textContent = '';
            if (!apiKeyValue) {
                errorMsg.textContent = 'Please enter your API key.';
                return;
            }
            if (apiKeyValue.length < 16) {
                errorMsg.textContent = 'API key should be at least 16 characters long.';
                return;
            }
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('connectBtn').textContent = 'Connecting...';
            try {
                // Try a simple Torn API endpoint
                const response = await fetch(`https://api.torn.com/v2/user/attacks?key=${apiKeyValue}`);
                if (response.ok) {
                    // Success: show dashboard
                    apiKey = apiKeyValue;
                    document.getElementById('mainBox').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'flex';
                    // Load item details for stocks images and item prices
                    await Promise.all([loadItemDetails(), loadItemPrices()]);
                    showTab('activities');
                    updateIncomeExpense();
                } else {
                    errorMsg.textContent = 'Could not connect. Please check your API key.';
                }
            } catch (e) {
                errorMsg.textContent = 'Network error. Please try again.';
            }
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('connectBtn').textContent = 'Connect';
        }
        document.getElementById('apiKey').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                connectAPI();
            }
        });
        // Tab switching
        document.querySelectorAll('.dashboard-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.dashboard-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                showTab(this.getAttribute('data-tab'));
            });
        });
        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
            document.getElementById('tab-' + tab).style.display = 'block';
            if (tab === 'rawlogs') {
                loadRawLogs();
            }
            if (tab === 'stocks') {
                loadStocks();
            }
            if (tab === 'activities') {
                loadTravelBar();
                updateIncomeExpense();
            }
            if (tab === 'faction') {
                loadFactionBasic();
            }
        }
        // Load Faction Basic Information
        async function loadFactionBasic() {
            const factionLoading = document.getElementById('faction-loading');
            const factionBasicInfo = document.getElementById('faction-basic-info');
            
            factionLoading.style.display = 'block';
            factionBasicInfo.style.display = 'none';
            
            try {
                // Load both basic info and members
                const [basicResponse, membersResponse] = await Promise.all([
                    fetch(`https://api.torn.com/v2/faction/basic?key=${apiKey}`),
                    fetch(`https://api.torn.com/v2/faction/members?key=${apiKey}`)
                ]);
                
                const basicData = await basicResponse.json();
                const membersData = await membersResponse.json();
                
                if (basicData.basic) {
                    const faction = basicData.basic;
                    const members = membersData.members || [];
                    
                    // Create member lookup for leader/co-leader names
                    const memberLookup = {};
                    members.forEach(member => {
                        memberLookup[member.id] = member.name;
                    });
                    
                    // Store user's faction ID globally
                    userFactionId = faction.id;
                    
                    // Update faction information
                    document.getElementById('faction-name').textContent = faction.name;
                    document.getElementById('faction-tag').textContent = `[${faction.tag}]`;
                    document.getElementById('faction-id').textContent = faction.id;
                    document.getElementById('faction-respect').textContent = faction.respect.toLocaleString();
                    document.getElementById('faction-members').textContent = faction.members;
                    document.getElementById('faction-capacity').textContent = faction.capacity;
                    document.getElementById('faction-days-old').textContent = faction.days_old;
                    
                    // Update leadership with names
                    const leaderName = memberLookup[faction.leader_id] || faction.leader_id;
                    const coLeaderName = faction.co_leader_id ? (memberLookup[faction.co_leader_id] || faction.co_leader_id) : 'None';
                    document.getElementById('faction-leader').textContent = leaderName;
                    document.getElementById('faction-co-leader').textContent = coLeaderName;
                    
                    // Update rank information
                    document.getElementById('faction-rank-name').textContent = faction.rank.name;
                    document.getElementById('faction-rank-level').textContent = faction.rank.level;
                    document.getElementById('faction-rank-wins').textContent = faction.rank.wins;
                    document.getElementById('faction-best-chain').textContent = faction.best_chain;
                    document.getElementById('faction-enlisted').textContent = faction.is_enlisted ? 'Yes' : 'No';
                    
                    // Update faction tag image
                    const tagImage = document.getElementById('faction-tag-image');
                    if (faction.tag_image) {
                        tagImage.src = `https://factiontags.torn.com/${faction.tag_image}`;
                    } else {
                        tagImage.src = 'https://via.placeholder.com/60x60?text=No+Tag';
                    }
                    
                    // Load members table
                    loadFactionMembers(members);
                    
                    factionLoading.style.display = 'none';
                    factionBasicInfo.style.display = 'block';
                } else {
                    factionLoading.textContent = 'No faction data found.';
                }
            } catch (error) {
                factionLoading.textContent = 'Failed to load faction data.';
                console.error('Error loading faction data:', error);
            }
        }

        // Global variables for sorting and war mode
        let currentMembers = [];
        let currentSortField = 'position';
        let currentSortDirection = 'asc';
        let warModeActive = false;
        let warHistoryData = [];
        let factionBalanceData = null;
        let itemPrices = {};
        let userFactionId = null;

        // Load Faction Members and Balance
        async function loadFactionMembers(members) {
            const membersLoading = document.getElementById('faction-members-loading');
            const membersList = document.getElementById('faction-members-list');
            const membersTbody = document.getElementById('members-tbody');
            
            membersLoading.style.display = 'block';
            membersList.style.display = 'none';
            membersTbody.innerHTML = '';
            
            try {
                // Load balance data
                const balanceResponse = await fetch(`https://api.torn.com/v2/faction/balance?key=${apiKey}`);
                const balanceData = await balanceResponse.json();
                
                // Store members globally for sorting
                currentMembers = members;
                
                // Add balance data to members
                if (balanceData.balance && balanceData.balance.members) {
                    const balanceMembers = balanceData.balance.members;
                    currentMembers.forEach(member => {
                        const balanceMember = balanceMembers.find(bm => bm.id === member.id);
                        if (balanceMember) {
                            member.money = balanceMember.money;
                            member.points = balanceMember.points;
                        } else {
                            member.money = 0;
                            member.points = 0;
                        }
                    });
                    
                    // Store faction balance data
                    factionBalanceData = balanceData.balance.faction;
                    renderFactionBalance();
                }
                
                // Add click event listeners to sortable headers
                document.querySelectorAll('.sortable').forEach(header => {
                    header.addEventListener('click', () => {
                        const sortField = header.getAttribute('data-sort');
                        handleSort(sortField);
                    });
                });
                
                // Update table headers based on war mode
                updateTableHeaders();
                
                // Initial sort by position
                handleSort('position');
                
                membersLoading.style.display = 'none';
                membersList.style.display = 'block';
            } catch (error) {
                membersLoading.textContent = 'Failed to load members.';
                console.error('Error loading members:', error);
            }
        }



        // Handle sorting
        function handleSort(sortField) {
            const membersTbody = document.getElementById('members-tbody');
            
            // Update sort direction
            if (currentSortField === sortField) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = sortField;
                currentSortDirection = 'asc';
            }
            
            // Update header indicators
            document.querySelectorAll('.sortable').forEach(header => {
                header.classList.remove('asc', 'desc');
                if (header.getAttribute('data-sort') === sortField) {
                    header.classList.add(currentSortDirection);
                }
            });
            
            // Sort members
            const sortedMembers = [...currentMembers].sort((a, b) => {
                let aValue, bValue;
                
                switch (sortField) {
                    case 'name':
                        aValue = a.name.toLowerCase();
                        bValue = b.name.toLowerCase();
                        break;
                    case 'level':
                        aValue = parseInt(a.level);
                        bValue = parseInt(b.level);
                        break;
                    case 'position':
                        const positionOrder = {
                            'Leader': 1,
                            'Co-leader': 2,
                            'Grand Glorning': 3,
                            'Mory Keeper': 4,
                            'Glorning Warden': 5,
                            'Initiate': 6
                        };
                        aValue = positionOrder[a.position] || 999;
                        bValue = positionOrder[b.position] || 999;
                        break;
                    case 'status':
                        aValue = getStatusText(a.status.state, a.status.description).toLowerCase();
                        bValue = getStatusText(b.status.state, b.status.description).toLowerCase();
                        break;
                    case 'money':
                        aValue = parseInt(a.money) || 0;
                        bValue = parseInt(b.money) || 0;
                        break;
                    case 'points':
                        aValue = parseInt(a.points) || 0;
                        bValue = parseInt(b.points) || 0;
                        break;
                    case 'lastAction':
                        aValue = a.last_action.timestamp;
                        bValue = b.last_action.timestamp;
                        break;
                    case 'daysInFaction':
                        aValue = parseInt(a.days_in_faction);
                        bValue = parseInt(b.days_in_faction);
                        break;
                    default:
                        aValue = a[sortField];
                        bValue = b[sortField];
                }
                
                if (aValue < bValue) return currentSortDirection === 'asc' ? -1 : 1;
                if (aValue > bValue) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Render sorted members
            renderMembers(sortedMembers);
        }

        // Update Table Headers based on war mode
        function updateTableHeaders() {
            const moneyHeader = document.querySelector('th[data-sort="money"]');
            const pointsHeader = document.querySelector('th[data-sort="points"]');
            
            if (warModeActive) {
                // Hide money and points columns in war mode
                if (moneyHeader) moneyHeader.style.display = 'none';
                if (pointsHeader) pointsHeader.style.display = 'none';
            } else {
                // Show money and points columns in peace mode
                if (moneyHeader) moneyHeader.style.display = 'table-cell';
                if (pointsHeader) pointsHeader.style.display = 'table-cell';
            }
        }

        // Render Faction Balance
        function renderFactionBalance() {
            const balanceSummary = document.getElementById('faction-balance-summary');
            const totalMoney = document.getElementById('faction-total-money');
            const totalPoints = document.getElementById('faction-total-points');
            const scope = document.getElementById('faction-scope');
            
            if (factionBalanceData) {
                totalMoney.textContent = `$${factionBalanceData.money.toLocaleString()}`;
                totalPoints.textContent = factionBalanceData.points.toLocaleString();
                scope.textContent = factionBalanceData.scope.toLocaleString();
                balanceSummary.style.display = 'block';
            }
        }

        // Render members in table
        function renderMembers(members) {
            const membersTbody = document.getElementById('members-tbody');
            membersTbody.innerHTML = '';
            
            for (const member of members) {
                const statusClass = getStatusClass(member.status.state, member.last_action.status);
                const statusText = getStatusText(member.status.state, member.status.description);
                
                let row;
                if (warModeActive) {
                    // War mode: hide money and points columns
                    row = `<tr>
                        <td><span class="member-name">${member.name}</span></td>
                        <td>${member.level}</td>
                        <td><span class="member-position">${member.position}</span></td>
                        <td><span class="member-status ${statusClass}">${statusText}</span></td>
                        <td>${member.last_action.relative}</td>
                        <td>${member.days_in_faction}</td>
                    </tr>`;
                } else {
                    // Peace mode: show all columns including money and points
                    row = `<tr>
                        <td><span class="member-name">${member.name}</span></td>
                        <td>${member.level}</td>
                        <td><span class="member-position">${member.position}</span></td>
                        <td><span class="member-status ${statusClass}">${statusText}</span></td>
                        <td>$${member.money ? member.money.toLocaleString() : '0'}</td>
                        <td>${member.points ? member.points.toLocaleString() : '0'}</td>
                        <td>${member.last_action.relative}</td>
                        <td>${member.days_in_faction}</td>
                    </tr>`;
                }
                membersTbody.innerHTML += row;
            }
        }

        // Helper function to get status CSS class
        function getStatusClass(state, lastActionStatus) {
            if (state === 'Hospital') return 'status-hospital';
            if (state === 'Jail') return 'status-jail';
            if (state === 'Traveling') return 'status-traveling';
            if (lastActionStatus === 'Online') return 'status-online';
            if (lastActionStatus === 'Idle') return 'status-idle';
            return 'status-offline';
        }

        // Helper function to get status text
        function getStatusText(state, description) {
            if (state === 'Hospital') return 'Hospital';
            if (state === 'Jail') return 'Jail';
            if (state === 'Traveling') return 'Traveling';
            if (state === 'Okay') return 'Okay';
            return description || 'Unknown';
        }

        // Toggle War Mode
        async function toggleWarMode() {
            const warModeBtn = document.getElementById('war-mode-toggle');
            const warModeSection = document.getElementById('war-mode-section');
            const balanceSummary = document.getElementById('faction-balance-summary');
            
            warModeActive = !warModeActive;
            
            if (warModeActive) {
                warModeBtn.classList.add('active');
                warModeBtn.textContent = '🛡️ Peace Mode';
                warModeSection.style.display = 'block';
                balanceSummary.style.display = 'none';
                
                // Load war history if not already loaded
                if (warHistoryData.length === 0) {
                    await loadWarHistory();
                } else {
                    renderWarHistory();
                }
                
                // Update table headers and re-render members table without money/points columns
                updateTableHeaders();
                renderMembers(currentMembers);
            } else {
                warModeBtn.classList.remove('active');
                warModeBtn.textContent = '⚔️ War Mode';
                warModeSection.style.display = 'none';
                balanceSummary.style.display = 'block';
                
                // Update table headers and re-render members table with money/points columns
                updateTableHeaders();
                renderMembers(currentMembers);
            }
        }

        // Load War History
        async function loadWarHistory() {
            const warHistoryLoading = document.getElementById('war-history-loading');
            const warHistoryList = document.getElementById('war-history-list');
            
            warHistoryLoading.style.display = 'block';
            warHistoryList.style.display = 'none';
            
            try {
                const response = await fetch(`https://api.torn.com/v2/faction/rankedwars?key=${apiKey}`);
                const data = await response.json();
                
                if (data.rankedwars) {
                    warHistoryData = data.rankedwars;
                    renderWarHistory();
                    warHistoryLoading.style.display = 'none';
                    warHistoryList.style.display = 'block';
                } else {
                    warHistoryLoading.textContent = 'No war history found.';
                }
            } catch (error) {
                warHistoryLoading.textContent = 'Failed to load war history.';
                console.error('Error loading war history:', error);
            }
        }

        // Render War History
        function renderWarHistory() {
            const warHistoryGrid = document.getElementById('war-history-grid');
            warHistoryGrid.innerHTML = '';
            
            // Get faction ID from the basic info
            const factionId = parseInt(document.getElementById('faction-id').textContent);
            
            // Show only the most recent 3 wars
            const recentWars = warHistoryData.slice(0, 3);
            
            for (const war of recentWars) {
                const isCurrent = war.end === 0;
                const ourFaction = war.factions.find(f => f.id === factionId);
                const opponent = war.factions.find(f => f.id !== factionId);
                const isWinner = war.winner === factionId;
                const isCompleted = war.end > 0;
                
                const warCard = document.createElement('div');
                warCard.className = `war-card ${isCurrent ? 'current' : ''}`;
                
                const startDate = new Date(war.start * 1000).toLocaleDateString();
                const endDate = isCompleted ? new Date(war.end * 1000).toLocaleDateString() : 'Ongoing';
                
                warCard.innerHTML = `
                    <div class="war-header">
                        <span class="war-id">War #${war.id}</span>
                        <span class="war-status ${isCurrent ? 'ongoing' : 'completed'}">
                            ${isCurrent ? 'Ongoing' : 'Completed'}
                        </span>
                    </div>
                    <div class="war-factions">
                        <div class="war-faction ${isWinner && isCompleted ? 'winner' : ''} ${ourFaction ? 'our-faction' : ''}">
                            <span class="faction-name">${ourFaction ? ourFaction.name : 'Unknown'}</span>
                            <div>
                                <span class="faction-score">${ourFaction ? ourFaction.score : 0}</span>
                                <span class="faction-chain">(${ourFaction ? ourFaction.chain : 0} chains)</span>
                            </div>
                        </div>
                        <div class="war-faction ${!isWinner && isCompleted ? 'winner' : ''}">
                            <span class="faction-name">${opponent ? opponent.name : 'Unknown'}</span>
                            <div>
                                <span class="faction-score">${opponent ? opponent.score : 0}</span>
                                <span class="faction-chain">(${opponent ? opponent.chain : 0} chains)</span>
                            </div>
                        </div>
                    </div>
                    <div class="war-target">
                        Target: ${war.target.toLocaleString()} | ${startDate}${isCompleted ? ` - ${endDate}` : ''}
                    </div>
                `;
                
                // Add click event to show war report
                warCard.style.cursor = 'pointer';
                warCard.addEventListener('click', () => showWarReport(war.id));
                
                warHistoryGrid.appendChild(warCard);
            }
        }

        // Show War Report Modal
        async function showWarReport(warId) {
            const modal = document.getElementById('war-report-modal');
            const loading = document.getElementById('war-report-loading');
            const data = document.getElementById('war-report-data');
            
            modal.style.display = 'flex';
            loading.style.display = 'block';
            data.style.display = 'none';
            
            try {
                // Load item prices if not already loaded
                if (Object.keys(itemPrices).length === 0) {
                    console.log('Loading item prices for war report...');
                    await loadItemPrices();
                }
                
                const response = await fetch(`https://api.torn.com/v2/faction/${warId}/rankedwarreport?key=${apiKey}`);
                const warData = await response.json();
                
                if (warData.rankedwarreport) {
                    renderWarReport(warData.rankedwarreport);
                    loading.style.display = 'none';
                    data.style.display = 'block';
                } else {
                    loading.textContent = 'No war report found.';
                }
            } catch (error) {
                loading.textContent = 'Failed to load war report.';
                console.error('Error loading war report:', error);
            }
        }

        // Render War Report
        function renderWarReport(report) {
            const title = document.getElementById('war-report-title');
            const meta = document.getElementById('war-report-meta');
            const factions = document.getElementById('war-report-factions');
            
            // Set title and meta
            title.textContent = `War #${report.id} Report`;
            
            const startDate = new Date(report.start * 1000).toLocaleDateString();
            const endDate = report.end > 0 ? new Date(report.end * 1000).toLocaleDateString() : 'Ongoing';
            const duration = report.end > 0 ? Math.round((report.end - report.start) / 3600) : 'Ongoing';
            
            meta.innerHTML = `
                <span>Start: ${startDate}</span>
                <span>End: ${endDate}</span>
                <span>Duration: ${duration}${typeof duration === 'number' ? ' hours' : ''}</span>
                <span>Winner: ${report.winner ? `Faction #${report.winner}` : 'None'}</span>
                <span>Forfeit: ${report.forfeit ? 'Yes' : 'No'}</span>
            `;
            
            // Render factions
            factions.innerHTML = '';
            
            for (const faction of report.factions) {
                const isWinner = report.winner === faction.id;
                const factionDiv = document.createElement('div');
                factionDiv.className = `war-faction-detail ${isWinner ? 'winner' : ''}`;
                
                factionDiv.innerHTML = `
                    <div class="faction-detail-header">
                        <span class="faction-detail-name">${faction.name}</span>
                        <span class="faction-detail-score">${faction.score.toLocaleString()}</span>
                    </div>
                    
                    <div class="faction-detail-stats">
                        <div class="faction-stat-item">
                            <div class="faction-stat-label">Attacks</div>
                            <div class="faction-stat-value">${faction.attacks.toLocaleString()}</div>
                        </div>
                        <div class="faction-stat-item">
                            <div class="faction-stat-label">Rank Before</div>
                            <div class="faction-stat-value">${faction.rank.before}</div>
                        </div>
                        <div class="faction-stat-item">
                            <div class="faction-stat-label">Rank After</div>
                            <div class="faction-stat-value">${faction.rank.after}</div>
                        </div>
                    </div>
                    
                    <div class="faction-rewards">
                        <div class="rewards-title">Rewards</div>
                        <div class="rewards-list">
                            <span class="reward-item">Respect: ${faction.rewards.respect.toLocaleString()}</span>
                            <span class="reward-item">Points: ${faction.rewards.points.toLocaleString()}</span>
                            ${faction.rewards.items.map(item => {
                                const itemPrice = itemPrices[item.id] || 0;
                                const totalPrice = itemPrice * item.quantity;
                                return `<span class="reward-item">${item.name} (${item.quantity}) - $${totalPrice.toLocaleString()}</span>`;
                            }).join('')}
                        </div>
                        ${faction.rewards.items.length > 0 ? `
                                            <div class="rewards-total">
                        <span class="reward-total-label">Cache Value:</span>
                        <span class="reward-total-value">$${calculateRewardValue(faction.rewards).toLocaleString()}</span>
                        ${userFactionId && faction.id === userFactionId ? `
                            <button class="payout-calculator-btn" onclick="showPayoutCalculator(${faction.id}, ${calculateRewardValue(faction.rewards)}, ${JSON.stringify(faction.members).replace(/"/g, '&quot;')})">
                                💰 Calculate Payout
                            </button>
                        ` : ''}
                    </div>
                ` : ''}
            </div>
                    
                    <div class="faction-members-section">
                        <div class="members-title">Members Performance</div>
                        <table class="members-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Level</th>
                                    <th>Attacks</th>
                                    <th>Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${faction.members.map(member => `
                                    <tr>
                                        <td>${member.name}</td>
                                        <td>${member.level}</td>
                                        <td class="member-attacks">${member.attacks}</td>
                                        <td class="member-score">${member.score.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                factions.appendChild(factionDiv);
            }
        }

        // Load Item Prices for Cache Items
        async function loadItemPrices() {
            try {
                // Cache item IDs from itemdetails.json with their market values
                const cacheItems = {
                    1119: 146199153, // Melee Cache
                    1120: 116548125, // Small Arms Cache  
                    1121: 206041526, // Medium Arms Cache
                    1122: 396975999  // Heavy Arms Cache
                };
                
                console.log('Setting cache item prices from itemdetails.json:', cacheItems);
                
                // Set the prices directly from itemdetails.json
                Object.entries(cacheItems).forEach(([itemId, price]) => {
                    itemPrices[parseInt(itemId)] = price;
                    console.log(`Set price for item ${itemId}: $${price.toLocaleString()}`);
                });
                
                console.log('Final loaded cache item prices:', itemPrices);
            } catch (error) {
                console.error('Error loading item prices:', error);
            }
        }

        // Calculate total value of rewards (only cache items)
        function calculateRewardValue(rewards) {
            let totalValue = 0;
            
            console.log('Calculating reward value for:', rewards);
            console.log('Available item prices:', itemPrices);
            
            // Only calculate value for cache items
            rewards.items.forEach(item => {
                const itemPrice = itemPrices[item.id] || 0;
                const itemTotal = itemPrice * item.quantity;
                totalValue += itemTotal;
                console.log(`Item ${item.id} (${item.name}): price=$${itemPrice.toLocaleString()}, qty=${item.quantity}, total=$${itemTotal.toLocaleString()}`);
            });
            
            console.log('Total cache value:', totalValue);
            return totalValue;
        }

        // Global variables for payout calculator
        let currentPayoutData = {
            factionId: null,
            totalCacheValue: 0,
            members: [],
            totalAttacks: 0
        };

        // Show Payout Calculator
        function showPayoutCalculator(factionId, cacheValue, membersData) {
            const modal = document.getElementById('payout-modal');
            
            // Parse members data if it's a string
            const members = typeof membersData === 'string' ? JSON.parse(membersData) : membersData;
            
            // Only show members from user's faction
            const userFactionMembers = members.filter(member => {
                // Check if this member belongs to the user's faction
                return userFactionId && factionId === userFactionId;
            });
            
            // If no members from user's faction, show error
            if (userFactionMembers.length === 0) {
                alert('No members from your faction found in this war report.');
                return;
            }
            
            // Calculate total attacks for user's faction only
            const totalAttacks = userFactionMembers.reduce((sum, member) => sum + member.attacks, 0);
            
            // Store current data
            currentPayoutData = {
                factionId: factionId,
                totalCacheValue: cacheValue,
                members: userFactionMembers,
                totalAttacks: totalAttacks
            };
            
            // Set estimated cache value in the help text
            document.getElementById('estimated-cache-value').textContent = cacheValue.toLocaleString();
            
            // Clear actual cache value input
            document.getElementById('actual-cache-value').value = '';
            
            // Update summary with estimated value
            document.getElementById('total-cache-value').textContent = `$${cacheValue.toLocaleString()}`;
            document.getElementById('faction-share').textContent = `$${Math.round(cacheValue * 0.2).toLocaleString()}`;
            document.getElementById('member-share').textContent = `$${Math.round(cacheValue * 0.8).toLocaleString()}`;
            document.getElementById('total-attacks').textContent = totalAttacks.toLocaleString();
            
            // Show modal and calculate initial payout
            modal.style.display = 'flex';
            calculatePayout();
        }

        // Close Payout Calculator
        function closePayoutCalculator() {
            const modal = document.getElementById('payout-modal');
            modal.style.display = 'none';
        }

        // Set Preset
        function setPreset(preset) {
            // Update active button
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const factionPercentage = document.getElementById('faction-percentage');
            const specialMemberName = document.getElementById('special-member-name');
            const specialMemberPercentage = document.getElementById('special-member-percentage');
            
            switch(preset) {
                case 'standard':
                    factionPercentage.value = 20;
                    specialMemberName.value = '';
                    specialMemberPercentage.value = 0;
                    break;
                case 'leader-bonus':
                    factionPercentage.value = 20;
                    specialMemberName.value = 'Leader';
                    specialMemberPercentage.value = 10;
                    break;
                case 'top-attackers':
                    factionPercentage.value = 20;
                    specialMemberName.value = 'Top 3 Attackers';
                    specialMemberPercentage.value = 15;
                    break;
                case 'custom':
                    // Keep current values
                    break;
            }
            
            calculatePayout();
        }

        // Calculate Payout
        function calculatePayout() {
            const factionPercentage = parseFloat(document.getElementById('faction-percentage').value) || 0;
            const specialMemberName = document.getElementById('special-member-name').value;
            const specialMemberPercentage = parseFloat(document.getElementById('special-member-percentage').value) || 0;
            
            // Get actual cache value if provided, otherwise use estimated
            const actualCacheValue = parseFloat(document.getElementById('actual-cache-value').value) || 0;
            const { totalCacheValue: estimatedCacheValue, members, totalAttacks } = currentPayoutData;
            
            // Use actual value if provided, otherwise use estimated
            const totalCacheValue = actualCacheValue > 0 ? actualCacheValue : estimatedCacheValue;
            
            // Calculate basic shares
            const factionShare = totalCacheValue * (factionPercentage / 100);
            const memberShare = totalCacheValue - factionShare;
            
            // Sort members by attacks (descending)
            const sortedMembers = [...members].sort((a, b) => b.attacks - a.attacks);
            
            // Calculate payouts
            const payouts = sortedMembers.map(member => {
                let payout = 0;
                let attackShare = 0;
                let isSpecial = false;
                
                if (member.attacks > 0) {
                    attackShare = (member.attacks / totalAttacks) * 100;
                    
                    // Check if member is special
                    if (specialMemberName && specialMemberPercentage > 0) {
                        if (specialMemberName === 'Leader' && member.name.toLowerCase().includes('leader')) {
                            isSpecial = true;
                        } else if (specialMemberName === 'Top 3 Attackers' && sortedMembers.indexOf(member) < 3) {
                            isSpecial = true;
                        } else if (member.name.toLowerCase().includes(specialMemberName.toLowerCase())) {
                            isSpecial = true;
                        }
                    }
                    
                    if (isSpecial && specialMemberPercentage > 0) {
                        // Special member gets bonus from the member share
                        const specialMembers = sortedMembers.filter(m => {
                            if (specialMemberName === 'Leader' && m.name.toLowerCase().includes('leader')) return true;
                            if (specialMemberName === 'Top 3 Attackers' && sortedMembers.indexOf(m) < 3) return true;
                            if (m.name.toLowerCase().includes(specialMemberName.toLowerCase())) return true;
                            return false;
                        });
                        
                        // Calculate special member bonus
                        const specialMemberAttacks = specialMembers.reduce((sum, m) => sum + m.attacks, 0);
                        const specialMemberBonus = (member.attacks / specialMemberAttacks) * (memberShare * (specialMemberPercentage / 100));
                        
                        // Calculate regular share from remaining member share
                        const remainingMemberShare = memberShare * ((100 - specialMemberPercentage) / 100);
                        const regularShare = (member.attacks / totalAttacks) * remainingMemberShare;
                        
                        payout = specialMemberBonus + regularShare;
                    } else {
                        // Regular member gets their proportional share of the member share
                        payout = (member.attacks / totalAttacks) * memberShare;
                    }
                }
                
                return {
                    ...member,
                    attackShare: attackShare,
                    payout: payout,
                    isSpecial: isSpecial
                };
            });
            
            // Update summary with current cache value
            document.getElementById('total-cache-value').textContent = `$${totalCacheValue.toLocaleString()}`;
            document.getElementById('faction-share').textContent = `$${Math.round(factionShare).toLocaleString()}`;
            document.getElementById('member-share').textContent = `$${Math.round(memberShare).toLocaleString()}`;
            
            // Render results
            renderPayoutResults(payouts);
        }

        // Render Payout Results
        function renderPayoutResults(payouts) {
            const tbody = document.getElementById('payout-tbody');
            tbody.innerHTML = '';
            
            payouts.forEach(member => {
                const row = document.createElement('tr');
                if (member.isSpecial) {
                    row.className = 'special-member';
                }
                
                row.innerHTML = `
                    <td>${member.name}</td>
                    <td>${member.level}</td>
                    <td>${member.attacks}</td>
                    <td>${member.attackShare.toFixed(1)}%</td>
                    <td class="member-payout">$${Math.round(member.payout).toLocaleString()}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Export Payout Table to CSV
        function exportPayoutTable() {
            const { totalCacheValue: estimatedCacheValue, totalAttacks } = currentPayoutData;
            const actualCacheValue = parseFloat(document.getElementById('actual-cache-value').value) || 0;
            const totalCacheValue = actualCacheValue > 0 ? actualCacheValue : estimatedCacheValue;
            const factionPercentage = parseFloat(document.getElementById('faction-percentage').value) || 0;
            const specialMemberName = document.getElementById('special-member-name').value;
            const specialMemberPercentage = parseFloat(document.getElementById('special-member-percentage').value) || 0;
            
            // Get current payout data
            const tbody = document.getElementById('payout-tbody');
            const rows = tbody.querySelectorAll('tr');
            
            // Create CSV content
            let csvContent = 'data:text/csv;charset=utf-8,';
            
            // Add header information
            csvContent += 'War Payout Breakdown\n';
            csvContent += `Total Cache Value,$${totalCacheValue.toLocaleString()}\n`;
            csvContent += `Faction Share,${factionPercentage}%\n`;
            csvContent += `Special Member,${specialMemberName || 'None'}\n`;
            csvContent += `Special Member Share,${specialMemberPercentage}%\n`;
            csvContent += `Total Attacks,${totalAttacks.toLocaleString()}\n`;
            csvContent += '\n';
            
            // Add table headers
            csvContent += 'Name,Level,Attacks,Attack Share (%),Payout,Special Member\n';
            
            // Add member data
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const name = cells[0].textContent.replace(/,/g, ';'); // Escape commas
                const level = cells[1].textContent;
                const attacks = cells[2].textContent;
                const attackShare = cells[3].textContent;
                const payout = cells[4].textContent.replace(/[$,]/g, ''); // Remove $ and commas
                const isSpecial = row.classList.contains('special-member') ? 'Yes' : 'No';
                
                csvContent += `${name},${level},${attacks},${attackShare},${payout},${isSpecial}\n`;
            });
            
            // Add summary
            csvContent += '\n';
            csvContent += 'Summary\n';
            csvContent += `Faction Share Amount,$${Math.round(totalCacheValue * (factionPercentage / 100)).toLocaleString()}\n`;
            csvContent += `Member Share Amount,$${Math.round(totalCacheValue * ((100 - factionPercentage) / 100)).toLocaleString()}\n`;
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `war_payout_${currentPayoutData.factionId}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            
            // Trigger download
            link.click();
            document.body.removeChild(link);
        }

        // Close War Report Modal
        function closeWarReport() {
            const modal = document.getElementById('war-report-modal');
            modal.style.display = 'none';
        }

        // Load Raw Logs
        async function loadRawLogs() {
            const logsLoading = document.getElementById('logs-loading');
            const logsTable = document.getElementById('logs-table');
            const logsTbody = document.getElementById('logs-tbody');
            logsLoading.style.display = 'block';
            logsTable.style.display = 'none';
            logsTbody.innerHTML = '';
            try {
                const url = `https://api.torn.com/user/?selections=log&key=${apiKey}&comment=TryItPage`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.log) {
                    const logs = Object.values(data.log).sort((a, b) => b.timestamp - a.timestamp);
                    for (const log of logs) {
                        let details = '';
                        if (log.data) {
                            if (log.data.item) {
                                const itemId = log.data.item;
                                const itemName = itemLookup[itemId] || `Item #${itemId}`;
                                details += `<span class='item-name'>${itemName}</span>`;
                            } else if (log.data.items_gained) {
                                const items = log.data.items_gained;
                                details += 'Gained: ' + Object.entries(items).map(([id, qty]) => {
                                    const name = itemLookup[id] || `Item #${id}`;
                                    return `${qty} × <span class='item-name'>${name}</span>`;
                                }).join(', ');
                            } else if (log.data.money) {
                                details += `Money: $${log.data.money.toLocaleString()}`;
                            } else if (log.data.stock) {
                                details += `Stock: #${log.data.stock}, Amount: ${log.data.amount}`;
                            } else if (log.data.sender) {
                                details += `Sender: ${log.data.sender}, Amount: $${log.data.money ? log.data.money.toLocaleString() : ''}`;
                            } else {
                                details += Object.entries(log.data).map(([k, v]) => `${k}: ${v}`).join(', ');
                            }
                        }
                        const date = new Date(log.timestamp * 1000);
                        const row = `<tr>
                            <td>${date.toLocaleString()}</td>
                            <td>${log.title}</td>
                            <td>${log.category}</td>
                            <td>${details}</td>
                        </tr>`;
                        logsTbody.innerHTML += row;
                    }
                    logsLoading.style.display = 'none';
                    logsTable.style.display = '';
                } else {
                    logsLoading.textContent = 'No logs found.';
                }
            } catch (e) {
                logsLoading.textContent = 'Failed to load logs.';
            }
        }
        // Load item details from itemdetails.json
        async function loadItemDetails() {
            try {
                const res = await fetch('itemdetails.json');
                itemDetails = await res.json();
            } catch (e) {
                itemDetails = {};
            }
        }
        // Hardcoded inventory list (name + quantity)
        const manualInventory = [
            { name: "Adhesive Plastic", quantity: 8 },
            { name: "Advent Calendar", quantity: 2 },
            { name: "Afro Comb", quantity: 10 },
            { name: "AK-47", quantity: 6 },
            { name: "Aluminum Plate", quantity: 32 },
            { name: "Ammonia", quantity: 21 },
            { name: "Anchor", quantity: 1 },
            { name: "Axe", quantity: 25 },
            { name: "Bag of Bloody Eyeballs", quantity: 1 },
            { name: "Bag of Bon Bons", quantity: 22 },
            { name: "Bag of Candy Kisses", quantity: 85 },
            { name: "Bag of Chocolate Kisses", quantity: 852 },
            { name: "Bag of Tootsie Rolls", quantity: 56 },
            { name: "Banana Orchid", quantity: 48 },
            { name: "Bandana", quantity: 10 },
            { name: "Bank Statement", quantity: 25 },
            { name: "Baseball Bat", quantity: 5 },
            { name: "Baseball Cap", quantity: 6 },
            { name: "Benelli M1 Tactical", quantity: 1 },
            { name: "Benelli M4 Super", quantity: 18 },
            { name: "Beretta M9", quantity: 5 },
            { name: "Bermudas", quantity: 3 },
            { name: "Bikini", quantity: 10 },
            { name: "Billfold", quantity: 3 },
            { name: "Binoculars", quantity: 10 },
            { name: "Birth Certificate", quantity: 1 },
            { name: "Blank DVDs", quantity: 1060 },
            { name: "Blanket", quantity: 10 },
            { name: "Bleach", quantity: 51 },
            { name: "Bleaching Tray", quantity: 14 },
            { name: "Blood Bag : A+", quantity: 5 },
            { name: "Blouse", quantity: 10 },
            { name: "Blowgun", quantity: 1 },
            { name: "Blowtorch", quantity: 7 },
            { name: "Blunderbuss", quantity: 1 },
            { name: "Bo Staff", quantity: 1 },
            { name: "Boat Engine", quantity: 6 },
            { name: "Bolt Cutters", quantity: 33 },
            { name: "Bond Paper", quantity: 157 },
            { name: "Bonded Latex", quantity: 10 },
            { name: "Bone", quantity: 3 },
            { name: "Bone Saw", quantity: 2 },
            { name: "Boob Tube", quantity: 17 },
            { name: "Bottle Cap", quantity: 109 },
            { name: "Bottle of Beer", quantity: 1251 },
            { name: "Bottle of Champagne", quantity: 264 },
            { name: "Bottle of Green Stout", quantity: 2 },
            { name: "Bottle of Kandy Kane", quantity: 2 },
            { name: "Bottle of Minty Mayhem", quantity: 8 },
            { name: "Bottle of Pumpkin Brew", quantity: 15 },
            { name: "Bottle of Sake", quantity: 21 },
            { name: "Bottle of Stinky Swamp Punch", quantity: 6 },
            { name: "Bottle of Tequila", quantity: 104 },
            { name: "Box of Bon Bons", quantity: 2 },
            { name: "Box of Extra Strong Mints", quantity: 2 },
            { name: "Box of Medical Supplies", quantity: 9 },
            { name: "Box of Tissues", quantity: 42 },
            { name: "Brass Ingot", quantity: 26 },
            { name: "Brick", quantity: 187 },
            { name: "Broom", quantity: 8 },
            { name: "BT MP9", quantity: 1 },
            { name: "Bucket", quantity: 59 },
            { name: "Bull Semen", quantity: 1 },
            { name: "Bulletproof Vest", quantity: 15 },
            { name: "Bunch of Black Roses", quantity: 29 },
            { name: "Bunch of Carnations", quantity: 83 },
            { name: "Bunch of Flowers", quantity: 32 },
            { name: "Bushmaster Carbon 15", quantity: 5 },
            { name: "Butterfly Knife", quantity: 5 }
            // ... add more as needed ...
        ];
        // Load Stocks Data
        async function loadStocks() {
            const stocksLoading = document.getElementById('stocks-loading');
            const stocksContent = document.getElementById('stocks-content');
            const stocksContainer = document.getElementById('stocks-container');
            
            stocksLoading.style.display = 'block';
            stocksContent.style.display = 'none';
            stocksContainer.innerHTML = '';
            
            try {
                // Load market data
                const marketResponse = await fetch(`https://api.torn.com/v2/torn/?selections=stocks&key=${apiKey}`);
                const marketData = await marketResponse.json();
                
                // Load user's stock portfolio
                const userResponse = await fetch(`https://api.torn.com/v2/user/?selections=stocks&key=${apiKey}`);
                const userData = await userResponse.json();
                
                if (marketData.stocks && userData.stocks) {
                    renderStocksTable(marketData.stocks, userData.stocks);
                    stocksLoading.style.display = 'none';
                    stocksContent.style.display = 'block';
                } else if (marketData.error) {
                    stocksLoading.textContent = `Market API Error: ${marketData.error}`;
                } else if (userData.error) {
                    stocksLoading.textContent = `User API Error: ${userData.error}`;
                } else {
                    stocksLoading.textContent = 'No stocks data found.';
                }
            } catch (error) {
                stocksLoading.textContent = 'Failed to load stocks data.';
                console.error('Error loading stocks:', error);
            }
        }

        // Get frequency description
        function getFrequencyDescription(frequency) {
            if (frequency === 7) {
                return 'Weekly';
            } else if (frequency === 31) {
                return 'Monthly';
            } else {
                return 'Custom';
            }
        }

        // Generate mock price changes for demonstration
        function generateMockPriceChanges(currentPrice, stockName) {
            // Actual 1y min prices from Torn City stock data
            const actualMinPrices = {
                "Evil Ducks Candy Corp": 576.65,
                "Mc Smoogle Corp": 726.53,
                "Herbal Releaf Co.": 367.73,
                "Symbiotic Ltd.": 635.82,
                "I Industries Ltd.": 120.36,
                "Performance Ribaldry": 578.15,
                "Feathery Hotels Group": 758.32,
                "The Torn City Times": 304.34,
                "Grain": 290.78,
                "Insured On Us": 156.56,
                "Munster Beverage Corp.": 512.23,
                "Torn City Health Service": 341.17,
                "Home Retail Group": 248.94,
                "PointLess": 71.46,
                "TC Music Industries": 209.36,
                "Eaglewood Mercenary": 268.16,
                "Torn & Shanghai Banking": 1080.14,
                "Alcoholics Synonymous": 322.91,
                "Lucky Shot Casino": 532.62,
                "Crude & Co": 788.77,
                "Wind Lines Travel": 709.48,
                "Torn City Investments": 1067.37,
                "Legal Authorities Group": 432.76,
                "Torn City Clothing": 517.55,
                "Syscore MFG": 605.80,
                "Empty Lunchbox Traders": 287.45,
                "Big Al's Gun Shop": 456.74,
                "Lo Squalo Waste": 99.85,
                "TC Media Productions": 470.75,
                "Tell Group Plc.": 125.57,
                "Torn City Motors": 273.86,
                "West Side University": 93.00,
                "Messaging Inc.": 242.57,
                "Yazoo": 46.08,
                "International School TC": 482.73
            };
            
            // Use actual min price if available, otherwise fallback to calculation
            const yearMin = actualMinPrices[stockName] || (currentPrice * (0.8 + Math.random() * 0.2));
            
            return {
                day1: (Math.random() - 0.5) * 2 * 0.01 * 100, // -1% to +1%
                week1: (Math.random() - 0.5) * 4 * 0.01 * 100, // -2% to +2%
                month1: (Math.random() - 0.5) * 8 * 0.01 * 100, // -4% to +4%
                year1: (Math.random() - 0.5) * 20 * 0.01 * 100, // -10% to +10%
                yearMin: yearMin
            };
        }

        // Render Stocks Table
        function renderStocksTable(stocks, userStocks) {
            const stocksContainer = document.getElementById('stocks-container');
            stocksContainer.innerHTML = '';
            
            const table = document.createElement('table');
            table.className = 'stocks-table';
            
            // Create header
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th class="sortable" data-sort="name">Stock ↕</th>
                    <th class="sortable" data-sort="price">Price ↕</th>
                    <th class="sortable" data-sort="price1yMin">1y Min ↕</th>
                    <th class="sortable" data-sort="price1yDiff">1y Diff ↕</th>
                    <th class="sortable" data-sort="myShares">My Shares ↕</th>
                    <th class="sortable" data-sort="avgPrice">Avg Price ↕</th>
                    <th class="sortable" data-sort="totalValue">Total Value ↕</th>
                    <th class="sortable" data-sort="profitLoss">P&L ↕</th>
                    <th class="sortable" data-sort="marketCap">Market Cap ↕</th>
                    <th class="sortable" data-sort="shares">Shares ↕</th>
                    <th class="sortable" data-sort="investors">Investors ↕</th>
                    <th class="sortable" data-sort="benefitType">Benefit ↕</th>
                    <th class="sortable" data-sort="frequency">Frequency ↕</th>
                </tr>
            `;
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            
            Object.values(stocks).forEach(stock => {
                // Generate mock price change data for demonstration
                const priceChanges = generateMockPriceChanges(stock.current_price, stock.name);
                
                // Calculate percentage difference between current price and 1y min
                const priceDiff = ((stock.current_price - priceChanges.yearMin) / priceChanges.yearMin) * 100;
                
                // Get user's stock data
                const userStock = userStocks[stock.stock_id];
                let portfolioData = {
                    shares: 0,
                    avgPrice: 0,
                    totalValue: 0,
                    profitLoss: 0,
                    profitLossPercent: 0
                };
                
                if (userStock) {
                    const totalShares = userStock.total_shares;
                    let totalCost = 0;
                    
                    // Calculate average price from transactions
                    Object.values(userStock.transactions).forEach(transaction => {
                        totalCost += transaction.shares * transaction.bought_price;
                    });
                    
                    const avgPrice = totalCost / totalShares;
                    const totalValue = totalShares * stock.current_price;
                    const profitLoss = totalValue - totalCost;
                    const profitLossPercent = (profitLoss / totalCost) * 100;
                    
                    portfolioData = {
                        shares: totalShares,
                        avgPrice: avgPrice,
                        totalValue: totalValue,
                        profitLoss: profitLoss,
                        profitLossPercent: profitLossPercent
                    };
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="stock-info">
                            <div class="stock-name">${stock.name}</div>
                            <div class="stock-acronym">${stock.acronym}</div>
                        </div>
                    </td>
                    <td class="stock-price">$${stock.current_price.toLocaleString()}</td>
                    <td class="stock-price-min">$${priceChanges.yearMin.toLocaleString()}</td>
                    <td class="stock-price-change ${priceDiff >= 0 ? 'positive' : 'negative'}">
                        ${priceDiff >= 0 ? '+' : ''}${priceDiff.toFixed(2)}%
                    </td>
                    <td class="stock-portfolio-shares">${portfolioData.shares.toLocaleString()}</td>
                    <td class="stock-portfolio-avg">$${portfolioData.avgPrice.toFixed(2)}</td>
                    <td class="stock-portfolio-value">$${portfolioData.totalValue.toLocaleString()}</td>
                    <td class="stock-portfolio-pnl ${portfolioData.profitLoss >= 0 ? 'positive' : 'negative'}">
                        ${portfolioData.profitLoss >= 0 ? '+' : ''}$${portfolioData.profitLoss.toLocaleString()}
                        <div class="pnl-percent">${portfolioData.profitLossPercent >= 0 ? '+' : ''}${portfolioData.profitLossPercent.toFixed(2)}%</div>
                    </td>
                    <td class="stock-market-cap">$${stock.market_cap.toLocaleString()}</td>
                    <td class="stock-shares">${stock.total_shares.toLocaleString()}</td>
                    <td class="stock-investors">${stock.investors.toLocaleString()}</td>
                    <td class="stock-benefit">
                        <div class="benefit-info">
                            <div class="benefit-type ${stock.benefit.type}">${stock.benefit.type}</div>
                            <div class="benefit-desc">${stock.benefit.description}</div>
                            <div class="benefit-req">Requires: ${stock.benefit.requirement.toLocaleString()} shares</div>
                        </div>
                    </td>
                    <td class="stock-frequency">
                        <div class="frequency-info">
                            <div class="frequency-days">${stock.benefit.frequency} days</div>
                            <div class="frequency-desc">${getFrequencyDescription(stock.benefit.frequency)}</div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            stocksContainer.appendChild(table);
            
            // Add sorting functionality
            addStocksSorting(table, stocks, userStocks);
        }
        // Add sorting functionality to stocks table
        function addStocksSorting(table, stocksData, userStocks) {
            let currentSort = { column: null, direction: 'asc' };
            
            table.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const sortColumn = header.getAttribute('data-sort');
                    
                    // Update sort direction
                    if (currentSort.column === sortColumn) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = sortColumn;
                        currentSort.direction = 'asc';
                    }
                    
                    // Update header indicators
                    table.querySelectorAll('.sortable').forEach(h => {
                        h.classList.remove('asc', 'desc');
                    });
                    header.classList.add(currentSort.direction);
                    
                    // Sort and re-render
                    const sortedStocks = sortStocksData(stocksData, sortColumn, currentSort.direction, userStocks);
                    renderStocksTableBody(table, sortedStocks, userStocks);
                });
            });
        }
        
        // Sort stocks data
        function sortStocksData(stocks, column, direction, userStocks) {
            const stocksArray = Object.values(stocks);
            
            stocksArray.sort((a, b) => {
                let aValue, bValue;
                
                switch (column) {
                    case 'name':
                        aValue = a.name.toLowerCase();
                        bValue = b.name.toLowerCase();
                        break;
                    case 'price':
                        aValue = a.current_price;
                        bValue = b.current_price;
                        break;
                    case 'price1yMin':
                        aValue = generateMockPriceChanges(a.current_price, a.name).yearMin;
                        bValue = generateMockPriceChanges(b.current_price, b.name).yearMin;
                        break;
                    case 'price1yDiff':
                        const aPriceChanges = generateMockPriceChanges(a.current_price, a.name);
                        const bPriceChanges = generateMockPriceChanges(b.current_price, b.name);
                        const aPriceDiff = ((a.current_price - aPriceChanges.yearMin) / aPriceChanges.yearMin) * 100;
                        const bPriceDiff = ((b.current_price - bPriceChanges.yearMin) / bPriceChanges.yearMin) * 100;
                        aValue = aPriceDiff;
                        bValue = bPriceDiff;
                        break;
                    case 'myShares':
                        const aUserStock = userStocks[a.stock_id];
                        const bUserStock = userStocks[b.stock_id];
                        aValue = aUserStock ? aUserStock.total_shares : 0;
                        bValue = bUserStock ? bUserStock.total_shares : 0;
                        break;
                    case 'avgPrice':
                        const aUserStockAvg = userStocks[a.stock_id];
                        const bUserStockAvg = userStocks[b.stock_id];
                        if (aUserStockAvg) {
                            let aTotalCost = 0;
                            Object.values(aUserStockAvg.transactions).forEach(transaction => {
                                aTotalCost += transaction.shares * transaction.bought_price;
                            });
                            aValue = aTotalCost / aUserStockAvg.total_shares;
                        } else {
                            aValue = 0;
                        }
                        if (bUserStockAvg) {
                            let bTotalCost = 0;
                            Object.values(bUserStockAvg.transactions).forEach(transaction => {
                                bTotalCost += transaction.shares * transaction.bought_price;
                            });
                            bValue = bTotalCost / bUserStockAvg.total_shares;
                        } else {
                            bValue = 0;
                        }
                        break;
                    case 'totalValue':
                        const aUserStockValue = userStocks[a.stock_id];
                        const bUserStockValue = userStocks[b.stock_id];
                        aValue = aUserStockValue ? aUserStockValue.total_shares * a.current_price : 0;
                        bValue = bUserStockValue ? bUserStockValue.total_shares * b.current_price : 0;
                        break;
                    case 'profitLoss':
                        const aUserStockPL = userStocks[a.stock_id];
                        const bUserStockPL = userStocks[b.stock_id];
                        if (aUserStockPL) {
                            let aTotalCost = 0;
                            Object.values(aUserStockPL.transactions).forEach(transaction => {
                                aTotalCost += transaction.shares * transaction.bought_price;
                            });
                            aValue = (aUserStockPL.total_shares * a.current_price) - aTotalCost;
                        } else {
                            aValue = 0;
                        }
                        if (bUserStockPL) {
                            let bTotalCost = 0;
                            Object.values(bUserStockPL.transactions).forEach(transaction => {
                                bTotalCost += transaction.shares * transaction.bought_price;
                            });
                            bValue = (bUserStockPL.total_shares * b.current_price) - bTotalCost;
                        } else {
                            bValue = 0;
                        }
                        break;
                    case 'marketCap':
                        aValue = a.market_cap;
                        bValue = b.market_cap;
                        break;
                    case 'shares':
                        aValue = a.total_shares;
                        bValue = b.total_shares;
                        break;
                    case 'investors':
                        aValue = a.investors;
                        bValue = b.investors;
                        break;
                    case 'benefitType':
                        aValue = a.benefit.type.toLowerCase();
                        bValue = b.benefit.type.toLowerCase();
                        break;
                    case 'frequency':
                        aValue = a.benefit.frequency;
                        bValue = b.benefit.frequency;
                        break;
                    default:
                        return 0;
                }
                
                if (aValue < bValue) return direction === 'asc' ? -1 : 1;
                if (aValue > bValue) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            return stocksArray;
        }
        
        // Render only the table body (for sorting)
        function renderStocksTableBody(table, stocks, userStocks) {
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            
            stocks.forEach(stock => {
                // Generate mock price change data for demonstration
                const priceChanges = generateMockPriceChanges(stock.current_price, stock.name);
                
                // Calculate percentage difference between current price and 1y min
                const priceDiff = ((stock.current_price - priceChanges.yearMin) / priceChanges.yearMin) * 100;
                
                // Get user's stock data
                const userStock = userStocks[stock.stock_id];
                let portfolioData = {
                    shares: 0,
                    avgPrice: 0,
                    totalValue: 0,
                    profitLoss: 0,
                    profitLossPercent: 0
                };
                
                if (userStock) {
                    const totalShares = userStock.total_shares;
                    let totalCost = 0;
                    
                    // Calculate average price from transactions
                    Object.values(userStock.transactions).forEach(transaction => {
                        totalCost += transaction.shares * transaction.bought_price;
                    });
                    
                    const avgPrice = totalCost / totalShares;
                    const totalValue = totalShares * stock.current_price;
                    const profitLoss = totalValue - totalCost;
                    const profitLossPercent = (profitLoss / totalCost) * 100;
                    
                    portfolioData = {
                        shares: totalShares,
                        avgPrice: avgPrice,
                        totalValue: totalValue,
                        profitLoss: profitLoss,
                        profitLossPercent: profitLossPercent
                    };
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="stock-info">
                            <div class="stock-name">${stock.name}</div>
                            <div class="stock-acronym">${stock.acronym}</div>
                        </div>
                    </td>
                    <td class="stock-price">$${stock.current_price.toLocaleString()}</td>
                    <td class="stock-price-min">$${priceChanges.yearMin.toLocaleString()}</td>
                    <td class="stock-price-change ${priceDiff >= 0 ? 'positive' : 'negative'}">
                        ${priceDiff >= 0 ? '+' : ''}${priceDiff.toFixed(2)}%
                    </td>
                    <td class="stock-portfolio-shares">${portfolioData.shares.toLocaleString()}</td>
                    <td class="stock-portfolio-avg">$${portfolioData.avgPrice.toFixed(2)}</td>
                    <td class="stock-portfolio-value">$${portfolioData.totalValue.toLocaleString()}</td>
                    <td class="stock-portfolio-pnl ${portfolioData.profitLoss >= 0 ? 'positive' : 'negative'}">
                        ${portfolioData.profitLoss >= 0 ? '+' : ''}$${portfolioData.profitLoss.toLocaleString()}
                        <div class="pnl-percent">${portfolioData.profitLossPercent >= 0 ? '+' : ''}${portfolioData.profitLossPercent.toFixed(2)}%</div>
                    </td>
                    <td class="stock-market-cap">$${stock.market_cap.toLocaleString()}</td>
                    <td class="stock-shares">${stock.total_shares.toLocaleString()}</td>
                    <td class="stock-investors">${stock.investors.toLocaleString()}</td>
                    <td class="stock-benefit">
                        <div class="benefit-info">
                            <div class="benefit-type ${stock.benefit.type}">${stock.benefit.type}</div>
                            <div class="benefit-desc">${stock.benefit.description}</div>
                            <div class="benefit-req">Requires: ${stock.benefit.requirement.toLocaleString()} shares</div>
                        </div>
                    </td>
                    <td class="stock-frequency">
                        <div class="frequency-info">
                            <div class="frequency-days">${stock.benefit.frequency} days</div>
                            <div class="frequency-desc">${getFrequencyDescription(stock.benefit.frequency)}</div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load live travel status
        let travelBarInterval = null;
        let travelLog = JSON.parse(localStorage.getItem('travelLog') || '[]');
        let lastTravelKey = null;
        async function loadTravelBar() {
            const travelBar = document.getElementById('travel-bar');
            if (!apiKey) {
                travelBar.textContent = 'Not connected.';
                return;
            }
            travelBar.textContent = 'Loading travel status...';
            if (travelBarInterval) clearInterval(travelBarInterval);
            let travelData = null;
            let start = null, end = null;
            async function updateTravel() {
                try {
                    const url = `https://api.torn.com/user/?selections=travel&key=${apiKey}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    if (data.travel && data.travel.destination) {
                        travelData = data.travel;
                        start = travelData.departed;
                        end = travelData.timestamp;
                        // Log completed travel if destination or departure changes
                        const travelKey = `${travelData.destination}|${travelData.method}|${travelData.departed}`;
                        if (lastTravelKey && lastTravelKey !== travelKey) {
                            // Previous travel completed, log it
                            const prev = travelLog.length > 0 ? travelLog[travelLog.length-1] : null;
                            if (!prev || prev.departed !== start) {
                                travelLog.push({
                                    destination: travelData.destination,
                                    method: travelData.method,
                                    departed: new Date(travelData.departed*1000).toLocaleString(),
                                    landed: new Date(end*1000).toLocaleString()
                                });
                                if (travelLog.length > 50) travelLog.shift(); // keep last 50
                                localStorage.setItem('travelLog', JSON.stringify(travelLog));
                            }
                        }
                        lastTravelKey = travelKey;
                        renderTravelBar();
                    } else {
                        travelBar.innerHTML = '<span>Not traveling</span>';
                        travelData = null;
                    }
                } catch (e) {
                    travelBar.innerHTML = '<span>Could not load travel status</span>';
                    travelData = null;
                }
            }
            function renderTravelBar() {
                if (!travelData) return;
                const dest = travelData.destination;
                const method = travelData.method;
                const timeLeft = travelData.time_left;
                const total = end - start;
                const elapsed = total - timeLeft;
                const percent = Math.max(0, Math.min(1, elapsed / total));
                const min = Math.floor(timeLeft / 60);
                const sec = timeLeft % 60;
                const hrs = Math.floor(timeLeft / 3600);
                const mins = Math.floor((timeLeft % 3600) / 60);
                const timeStr = `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${(timeLeft % 60).toString().padStart(2, '0')}`;
                const landingTime = new Date((end) * 1000);
                const landingStr = landingTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                // Use flag emoji for destination if possible
                const destFlag = getCountryFlag(dest) || '🛬';
                travelBar.innerHTML = `
                  <div class="travel-bar-content">
                    <div class="travel-bar-top" style="font-weight:700; font-size:0.95rem;">
                      Torn to ${dest}.
                    </div>
                    <div class="travel-bar-top" style="font-weight:700; font-size:0.95rem; margin-top:0;">
                      Remaining Flight Time – <span style="font-variant-numeric: tabular-nums">${timeStr}</span>
                    </div>
                    <div class="travel-bar-info">Landing at ${landingStr}.</div>
                    <div class="travel-bar-icons">
                      <span class="travel-bar-icon">${getTornIcon()}</span>
                      <div class="travel-bar-progress-wrap">
                        <div class="travel-bar-progress-bg">
                          <div class="travel-bar-progress" style="width:${percent * 100}%"></div>
                          <span class="travel-bar-arrow" style="left:calc(${percent * 100}% - 10px)">➤</span>
                        </div>
                      </div>
                      <span class="travel-bar-icon">${destFlag}</span>
                    </div>
                  </div>
                `;
            }
            await updateTravel();
            travelBarInterval = setInterval(async () => {
                if (travelData && travelData.time_left > 0) {
                    travelData.time_left--;
                    renderTravelBar();
                } else {
                    await updateTravel();
                }
            }, 1000);
        }
        // Travel bar click to open log
        document.getElementById('travel-bar').onclick = function() {
            showTravelLog();
        };
        function showTravelLog() {
            const modal = document.getElementById('travel-log-modal');
            // Count travels by day, week, month
            const now = new Date();
            let daily = 0, weekly = 0, monthly = 0;
            let destDaily = {}, destWeekly = {}, destMonthly = {};
            for (let i = 0; i < travelLog.length; i++) {
                const t = travelLog[i];
                const landed = new Date(t.landed);
                // Daily: same calendar day
                if (landed.toDateString() === now.toDateString()) {
                    daily++;
                    destDaily[t.destination] = (destDaily[t.destination]||0)+1;
                }
                // Weekly: same ISO week
                const weekStart = new Date(now);
                weekStart.setDate(now.getDate() - now.getDay());
                weekStart.setHours(0,0,0,0);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 7);
                if (landed >= weekStart && landed < weekEnd) {
                    weekly++;
                    destWeekly[t.destination] = (destWeekly[t.destination]||0)+1;
                }
                // Monthly: same calendar month/year
                if (landed.getFullYear() === now.getFullYear() && landed.getMonth() === now.getMonth()) {
                    monthly++;
                    destMonthly[t.destination] = (destMonthly[t.destination]||0)+1;
                }
            }
            document.getElementById('travel-count-daily').textContent = daily;
            document.getElementById('travel-count-weekly').textContent = weekly;
            document.getElementById('travel-count-monthly').textContent = monthly;
            // Render destination breakdowns
            function renderDestBreakdown(obj) {
                const keys = Object.keys(obj);
                if (keys.length === 0) return '<span style="opacity:0.7;">No travels</span>';
                return keys.map(k => `${k} <span style='opacity:0.7;'>(${obj[k]})</span>`).join(', ');
            }
            document.getElementById('travel-dest-daily').innerHTML = renderDestBreakdown(destDaily);
            document.getElementById('travel-dest-weekly').innerHTML = renderDestBreakdown(destWeekly);
            document.getElementById('travel-dest-monthly').innerHTML = renderDestBreakdown(destMonthly);
            modal.style.display = 'flex';
        }
        function closeTravelLog() {
            document.getElementById('travel-log-modal').style.display = 'none';
        }
        // Helper for Torn icon
        function getTornIcon() {
            return '<svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="11" cy="11" r="11" fill="#232b33"/><text x="50%" y="57%" text-anchor="middle" fill="#fff" font-size="13" font-family="Arial, sans-serif" font-weight="bold" dy=".3em">T</text></svg>';
        }
        // Helper for country flag emoji (basic)
        function getCountryFlag(dest) {
            const flags = {
                "Switzerland": "🇨🇭",
                "Mexico": "🇲🇽",
                "Canada": "🇨🇦",
                "Hawaii": "🇺🇸",
                "UAE": "🇦🇪",
                "China": "🇨🇳",
                "Japan": "🇯🇵",
                "Argentina": "🇦🇷",
                "Cayman Islands": "🇰🇾",
                "United Kingdom": "🇬🇧",
                "South Africa": "🇿🇦",
                "Zurich": "🇨🇭",
                "London": "🇬🇧",
                "Torn": "<svg width=\"22\" height=\"22\" viewBox=\"0 0 22 22\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"><circle cx=\"11\" cy=\"11\" r=\"11\" fill=\"#232b33\"/><text x=\"50%\" y=\"57%\" text-anchor=\"middle\" fill=\"#fff\" font-size=\"13\" font-family=\"Arial, sans-serif\" font-weight=\"bold\" dy=\".3em\">T</text></svg>"
            };
            return flags[dest] || '';
        }
        // Log type IDs for income and expenses
        const INCOME_LOG_TYPES = new Set([
            5451,5460,5461,6011,6012,5720,9015,9030,9053,9071,6220,6221,6222,6509,4810,4441,5511,5531,1113,1226,4322,4323,5928,8300,8305,8313,8320,8331,8341,8355,8357,8374,8395,8435,8442,8444,8452,8462,8742,6710,6793,6811,5371,8940
        ]);
        const EXPENSE_LOG_TYPES = new Set([
            5715,9165,5450,6010,6001,6002,6203,6204,6205,6206,1112,1225,4200,4201,5510,4800,4440,4480,6726,6735,6285,8301,8306,8311,8321,8332,8354,8356,8372,8396,8436,8443,8451,8461,5920,5927,6290,6291,6292,5320,6015,5370,5420,8740,5970,15031
        ]);

        // Helper to get start of day/week/month
        function getPeriodStart(period) {
            const now = new Date();
            if (period === 'daily') {
                return new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime() / 1000;
            } else if (period === 'weekly') {
                const day = now.getDay();
                const diff = now.getDate() - day;
                return new Date(now.getFullYear(), now.getMonth(), diff).getTime() / 1000;
            } else if (period === 'monthly') {
                return new Date(now.getFullYear(), now.getMonth(), 1).getTime() / 1000;
            }
        }

        // Fetch logs and calculate income/expenses
        async function updateIncomeExpense() {
            try {
                const res = await fetch('/api/logs');
                const data = await res.json();
                if (!data.log) return;
                const logs = Object.values(data.log);
                const now = Math.floor(Date.now() / 1000);
                const periods = ['daily','weekly','monthly'];
                const income = { daily: 0, weekly: 0, monthly: 0 };
                const expense = { daily: 0, weekly: 0, monthly: 0 };
                for (const period of periods) {
                    const start = getPeriodStart(period);
                    for (const log of logs) {
                        if (!log.timestamp || log.timestamp < start) continue;
                        const type = parseInt(log.logId);
                        let amount = 0;
                        if (log.data && typeof log.data.money === 'number') {
                            amount = log.data.money;
                        } else if (log.data && typeof log.data.amount === 'number') {
                            amount = log.data.amount;
                        }
                        if (INCOME_LOG_TYPES.has(type)) {
                            income[period] += amount;
                        } else if (EXPENSE_LOG_TYPES.has(type)) {
                            expense[period] += amount;
                        }
                    }
                }
                // Update UI
                document.getElementById('income-amount').textContent = `$${income['daily'].toLocaleString()}`;
                expenseAmounts.daily = expense.daily;
                expenseAmounts.weekly = expense.weekly;
                expenseAmounts.monthly = expense.monthly;
                setExpensePeriod(currentExpensePeriod);
            } catch (e) {
                // fallback: show $0
                document.getElementById('income-amount').textContent = '$0';
                expenseAmounts.daily = 0;
                expenseAmounts.weekly = 0;
                expenseAmounts.monthly = 0;
                setExpensePeriod(currentExpensePeriod);
            }
        }
        // Expense toggle logic
        const expenseAmounts = {
            daily: 0,
            weekly: 0,
            monthly: 0
        };
        let currentExpensePeriod = 'daily';
        function setExpensePeriod(period) {
            currentExpensePeriod = period;
            document.getElementById('expense-amount').textContent = `$${expenseAmounts[period].toLocaleString()}`;
            document.getElementById('expense-toggle-daily').classList.remove('active');
            document.getElementById('expense-toggle-weekly').classList.remove('active');
            document.getElementById('expense-toggle-monthly').classList.remove('active');
            document.getElementById('expense-toggle-' + period).classList.add('active');
        }
        // Set default on load
        setExpensePeriod('daily');
        // Update income/expense on load
        updateIncomeExpense();
    </script>
</body>
</html> 